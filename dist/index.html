<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
}

.js-enabled .status-message {
  display: none;
}

.outerwrapper {
  width: 100%;
  position: relative;
  border: 1px solid #c8c7cf;
  display: none;
}
.outerwrapper h2, .outerwrapper h3, .outerwrapper p, .outerwrapper fieldset {
  padding: 10px 10px 0 10px;
  margin: 0;
}
.outerwrapper li {
  display: inline-block;
}
.outerwrapper .key {
  margin: 10px 0 0 0;
  padding-left: 10px;
}
.outerwrapper .key li {
  padding: 0 0 0 6px;
  margin: 4px 15px 8px 0;
}
.outerwrapper .agrd-select legend, .outerwrapper .agrd-select ul, .outerwrapper .agrd-select li {
  display: inline;
}
.outerwrapper .agrd-select ul {
  padding-left: 2px;
  margin-bottom: 10px;
}
.outerwrapper .agrd-select li {
  padding: 0 10px 0 0;
}
.outerwrapper .footnote {
  padding-top: 0px;
  font-size: 0.8em;
  color: #666;
}
.outerwrapper .chart {
  position: relative;
  margin-top: 10px;
  margin-bottom: -5px;
}
.outerwrapper .widget-tooltip {
  position: absolute;
  height: auto;
  padding: 6px 10px 6px 15px;
  color: #ccc;
  background-color: #333;
  pointer-events: none;
  font-size: 0.8em;
  line-height: 1.4em;
  opacity: 1;
  transition: opacity 0.2s ease;
}
.outerwrapper .widget-tooltip p {
  padding: 0;
}
.outerwrapper .tooltip-left:before {
  content: "";
  position: absolute;
  bottom: 13px;
  right: -7px;
  border-left: 8px solid #333;
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
  border-right: 0;
}
.outerwrapper .tooltip-right:before {
  content: "";
  position: absolute;
  bottom: 13px;
  left: -7px;
  border-right: 8px solid #333;
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
  border-left: 0;
}
.outerwrapper .hidden {
  opacity: 0;
  pointer-events: none;
}

</style>
<noscript>
	This interactive graphic requires javascript to be enabled.
</noscript>

<div class="status-message">
	<p>This interactive graphic requires a modern browser (e.g. Chrome, Safari or Firefox) with javascript enabled.</p>
	<p>The data used to build this graphic can be downloaded as comma-separated values in plain-text form here: <a href="#" title="Download interd-data.csv">tbc.csv</a>.</p>
</div>

<!-- DELETE: Just for polopoly preview -->
<script src="https://code.jquery.com/jquery-1.4.min.js" type="text/javascript"></script>

<div class="outerwrapper">
	<h2>INTERACTIVE: SHIFTING RANKS</h2>
	<p>For the first time in modern history, middle-income countries are investing more in public-sector agricultural research and development (AgR&D) than are high-income ones.</p>

	<p>Hover over each country to see its government's spending on AgR&D in 2011 compared with 1960, converted from local currencies to dollars using 2009 purchasing power parity (PPP) exchange rates.</p>

	<ul class="key">
		<li style="border-left: 20px solid #ee7183;">High income</li>
		<li style="border-left: 20px solid #44b8c9;">Middle income</li>
		<li style="border-left: 20px solid #8fc297;">Low income</li>
	</ul>

	<form class="agrd-select">
		<p>Select a country to highlight:

		<select name="agrd-country-select" id="agrd-country-select">
		</select></p>


		<fieldset id="agrd-year">
			<legend>Select a year to display:</legend>
			<ul>
				<li>
					<label for="agrd1960">
						<input type="radio" id="agrd1960" name="year" value="agrd-1960" checked/>
						1960
					</label>
				</li>
				<li>
					<label for="agrd2011">
						<input type="radio" id="agrd2011" name="year" value="agrd-2011" />
						2011
					</label>
				</li>
			</ul>
		</fieldset>
	</form>

	<div class="chart" id="agrd-chart">
		<div class="widget-tooltip tooltip-left hidden" id="widget-tooltip">
			<p id="agrd-country"></p>
			<p>$ <span id="agrd-value"></span> million</p>
		</div>
	</div>

	<p class="footnote">Countries with a AgR&D spend of less than US$2 million in 1960 or 2011 are not shown.</p>
</div>
<!--[if gt IE 8]><!-->
<script type="text/javascript">
var data = [{"id":"earth","parentId":""},{"id":"high income","parentId":"earth"},{"id":"low income","parentId":"earth"},{"id":"middle income","parentId":"earth"},{"agrd1960":11.336632,"agrd2011":105.95621,"id":"Angola","parentId":"middle income"},{"agrd1960":0.18449116,"agrd2011":17.350664,"id":"Botswana","parentId":"middle income"},{"agrd1960":1.3508072,"agrd2011":9.3277922,"id":"Burundi","parentId":"low income"},{"agrd1960":9.3876257,"agrd2011":155.07729,"id":"Cameroon","parentId":"middle income"},{"agrd1960":1.9970516,"agrd2011":3.3035855,"id":"Cape Verde","parentId":"middle income"},{"agrd1960":6.7654042,"agrd2011":3.2452915,"id":"Central African Republic","parentId":"low income"},{"agrd1960":6.5136189,"agrd2011":6.9717793,"id":"Chad","parentId":"low income"},{"agrd1960":6.8103275,"agrd2011":7.0076509,"id":"Congo","parentId":"middle income"},{"agrd1960":13.843214,"agrd2011":31.404057,"id":"Benin","parentId":"low income"},{"agrd1960":4.7877488,"agrd2011":2.2551143,"id":"Gabon","parentId":"middle income"},{"agrd1960":6.5331607,"agrd2011":5.0050807,"id":"Gambia","parentId":"low income"},{"agrd1960":18.307493,"agrd2011":86.388809,"id":"Ghana","parentId":"middle income"},{"agrd1960":0.82882011,"agrd2011":6.3892803,"id":"Guinea","parentId":"low income"},{"agrd1960":46.927189,"agrd2011":75.816124,"id":"Côte d'Ivoire","parentId":"middle income"},{"agrd1960":51.527546,"agrd2011":256.62766,"id":"Kenya","parentId":"low income"},{"agrd1960":0.22253069,"agrd2011":2.4358733,"id":"Lesotho","parentId":"middle income"},{"agrd1960":0.024051702,"agrd2011":4.7759008,"id":"Liberia","parentId":"low income"},{"agrd1960":30.011063,"agrd2011":12.267246,"id":"Madagascar","parentId":"low income"},{"agrd1960":17.938038,"agrd2011":41.457996,"id":"Malawi","parentId":"low income"},{"agrd1960":7.3246474,"agrd2011":49.321697,"id":"Mali","parentId":"low income"},{"agrd1960":2.8325934,"agrd2011":8.5042982,"id":"Mauritania","parentId":"middle income"},{"agrd1960":3.8588519,"agrd2011":30.054422,"id":"Mauritius","parentId":"middle income"},{"agrd1960":1.1097147,"agrd2011":21.589827,"id":"Mozambique","parentId":"low income"},{"agrd1960":6.716939,"agrd2011":58.310841,"id":"Namibia","parentId":"middle income"},{"agrd1960":4.7022166,"agrd2011":7.7157712,"id":"Niger","parentId":"low income"},{"agrd1960":78.678566,"agrd2011":483.9693,"id":"Nigeria","parentId":"middle income"},{"agrd1960":0.49736261,"agrd2011":0.18208393,"id":"Guinea-Bissau","parentId":"low income"},{"agrd1960":0.19259852,"agrd2011":2.7794354,"id":"Eritrea","parentId":"low income"},{"agrd1960":1.5180112,"agrd2011":4.1703386,"id":"Zimbabwe","parentId":"low income"},{"agrd1960":2.1156814,"agrd2011":32.0177,"id":"Rwanda","parentId":"low income"},{"agrd1960":0.1225067,"agrd2011":0.5410015,"id":"São Tomé and Príncipe","parentId":"middle income"},{"agrd1960":22.657969,"agrd2011":31.110268,"id":"Senegal","parentId":"middle income"},{"agrd1960":1.8906842,"agrd2011":8.9961529,"id":"Sierra Leone","parentId":"low income"},{"agrd1960":3.6972463,"agrd2011":0.45560578,"id":"Somalia","parentId":"low income"},{"agrd1960":237.17857,"agrd2011":338.1478,"id":"South Africa","parentId":"middle income"},{"agrd1960":34.753563,"agrd2011":58.730473,"id":"Sudan (former)","parentId":"middle income"},{"agrd1960":1.326959,"agrd2011":6.3305359,"id":"Swaziland","parentId":"middle income"},{"agrd1960":9.3346214,"agrd2011":94.671783,"id":"Tanzania","parentId":"low income"},{"agrd1960":12.037609,"agrd2011":10.651837,"id":"Togo","parentId":"low income"},{"agrd1960":12.633537,"agrd2011":125.07925,"id":"Uganda","parentId":"low income"},{"agrd1960":6.0684686,"agrd2011":28.988504,"id":"Burkina Faso","parentId":"low income"},{"agrd1960":4.1398416,"agrd2011":79.65377,"id":"Ethiopia","parentId":"low income"},{"agrd1960":22.973543,"agrd2011":18.07942,"id":"Democratic Republic of the Congo","parentId":"low income"},{"agrd1960":11.38972,"agrd2011":18.954071,"id":"Zambia","parentId":"middle income"},{"agrd1960":47.100182,"agrd2011":498.61349,"id":"Egypt","parentId":"middle income"},{"agrd1960":66.91275,"agrd2011":924.05444,"id":"Iran","parentId":"middle income"},{"agrd1960":3.0579054,"agrd2011":43.206177,"id":"Jordan","parentId":"middle income"},{"agrd1960":54.494331,"agrd2011":280.4455,"id":"Morocco","parentId":"middle income"},{"agrd1960":1.9495423,"agrd2011":90.953186,"id":"Syria","parentId":"middle income"},{"agrd1960":12.111362,"agrd2011":99.820923,"id":"Tunisia","parentId":"middle income"},{"agrd1960":142.07428,"agrd2011":502.54633,"id":"Argentina","parentId":"middle income"},{"agrd1960":5.0434184,"agrd2011":6.6370702,"id":"Bolivia","parentId":"middle income"},{"agrd1960":344.72424,"agrd2011":1839.4761,"id":"Brazil","parentId":"middle income"},{"agrd1960":0.40652815,"agrd2011":2.6275847,"id":"Belize","parentId":"middle income"},{"agrd1960":111.76901,"agrd2011":199.856,"id":"Colombia","parentId":"middle income"},{"agrd1960":11.368704,"agrd2011":31.355742,"id":"Costa Rica","parentId":"middle income"},{"agrd1960":84.971519,"agrd2011":202.80173,"id":"Cuba","parentId":"middle income"},{"agrd1960":2.3919852,"agrd2011":21.452148,"id":"Dominican Republic","parentId":"middle income"},{"agrd1960":9.6352921,"agrd2011":17.138359,"id":"Ecuador","parentId":"middle income"},{"agrd1960":22.877945,"agrd2011":7.8716197,"id":"El Salvador","parentId":"middle income"},{"agrd1960":8.7887135,"agrd2011":14.294127,"id":"Guatemala","parentId":"middle income"},{"agrd1960":3.3354979,"agrd2011":9.6543045,"id":"Guyana","parentId":"middle income"},{"agrd1960":5.4786429,"agrd2011":4.4621749,"id":"Haiti","parentId":"low income"},{"agrd1960":1.432446,"agrd2011":17.828995,"id":"Honduras","parentId":"middle income"},{"agrd1960":8.2671804,"agrd2011":8.5982733,"id":"Jamaica","parentId":"middle income"},{"agrd1960":54.216106,"agrd2011":661.28223,"id":"Mexico","parentId":"middle income"},{"agrd1960":2.1957772,"agrd2011":45.933865,"id":"Nicaragua","parentId":"middle income"},{"agrd1960":2.0196693,"agrd2011":10.748732,"id":"Panama","parentId":"middle income"},{"agrd1960":1.8963994,"agrd2011":17.331875,"id":"Paraguay","parentId":"middle income"},{"agrd1960":20.731459,"agrd2011":131.01738,"id":"Peru","parentId":"middle income"},{"agrd1960":1.7767061,"agrd2011":3.389673,"id":"Saint Lucia","parentId":"middle income"},{"agrd1960":40.258266,"agrd2011":211.34567,"id":"Venezuela","parentId":"middle income"},{"agrd1960":162.7312,"agrd2011":492.51328,"id":"Australia","parentId":"high income"},{"agrd1960":35.447369,"agrd2011":114.88011,"id":"Austria","parentId":"high income"},{"agrd1960":4.0320611,"agrd2011":1.9888142,"id":"Barbados","parentId":"high income"},{"agrd1960":216.9267,"agrd2011":1008.3636,"id":"Canada","parentId":"high income"},{"agrd1960":22.315975,"agrd2011":63.772449,"id":"Chile","parentId":"high income"},{"agrd1960":1.7975826,"agrd2011":7.6226244,"id":"Cyprus","parentId":"high income"},{"agrd1960":63.753384,"agrd2011":67.576584,"id":"Denmark","parentId":"high income"},{"agrd1960":38.653961,"agrd2011":193.25804,"id":"Finland","parentId":"high income"},{"agrd1960":120.89775,"agrd2011":1082.9164,"id":"France","parentId":"high income"},{"agrd1960":390.67664,"agrd2011":1189.474,"id":"Germany","parentId":"high income"},{"agrd1960":26.682419,"agrd2011":52.079506,"id":"Greece","parentId":"high income"},{"agrd1960":0.16769227,"agrd2011":2.2642882,"id":"Guam","parentId":"high income"},{"agrd1960":3.8220613,"agrd2011":16.235655,"id":"Iceland","parentId":"high income"},{"agrd1960":42.886456,"agrd2011":121.98071,"id":"Ireland","parentId":"high income"},{"agrd1960":20.231112,"agrd2011":135.92468,"id":"Israel","parentId":"high income"},{"agrd1960":94.41568,"agrd2011":992.90765,"id":"Italy","parentId":"high income"},{"agrd1960":187.43454,"agrd2011":3465.0422,"id":"Japan","parentId":"high income"},{"agrd1960":71.076721,"agrd2011":962.18115,"id":"South Korea","parentId":"high income"},{"agrd1960":143.06166,"agrd2011":660.78137,"id":"Netherlands","parentId":"high income"},{"agrd1960":41.690453,"agrd2011":295.0889,"id":"New Zealand","parentId":"high income"},{"agrd1960":50.035477,"agrd2011":148.40483,"id":"Norway","parentId":"high income"},{"agrd1960":12.788019,"agrd2011":147.42816,"id":"Portugal","parentId":"high income"},{"agrd1960":22.775259,"agrd2011":11.345594,"id":"Puerto Rico","parentId":"high income"},{"agrd1960":0.60222632,"agrd2011":10.450477,"id":"Qatar","parentId":"high income"},{"agrd1960":0.1905853,"agrd2011":0.1709819,"id":"Saint Kitts and Nevis","parentId":"high income"},{"agrd1960":2.0662529,"agrd2011":19.674835,"id":"Singapore","parentId":"high income"},{"agrd1960":29.648958,"agrd2011":904.93115,"id":"Spain","parentId":"high income"},{"agrd1960":22.31731,"agrd2011":155.59677,"id":"Sweden","parentId":"high income"},{"agrd1960":14.280046,"agrd2011":133.03503,"id":"Switzerland","parentId":"high income"},{"agrd1960":5.9005804,"agrd2011":3.0638211,"id":"Trinidad and Tobago","parentId":"high income"},{"agrd1960":0.26085922,"agrd2011":17.068302,"id":"United Arab Emirates","parentId":"high income"},{"agrd1960":299.23123,"agrd2011":740.30792,"id":"United Kingdom","parentId":"high income"},{"agrd1960":1250.5532,"agrd2011":4403.2378,"id":"United States","parentId":"high income"},{"agrd1960":6.7033405,"agrd2011":90.000343,"id":"Uruguay","parentId":"high income"},{"agrd1960":0.098076835,"agrd2011":1.3948632,"id":"US Virgin Islands","parentId":"high income"},{"agrd1960":51.665165,"agrd2011":276.5304,"id":"Belgium","parentId":"high income"},{"agrd1960":0.79465991,"agrd2011":32.216442,"id":"Luxembourg","parentId":"high income"},{"agrd1960":32.272133,"agrd2011":486.11023,"id":"Turkey","parentId":"middle income"},{"agrd1960":21.627705,"agrd2011":195.18259,"id":"Bangladesh","parentId":"low income"},{"agrd1960":0.55008543,"agrd2011":3.1974747,"id":"Solomon Islands","parentId":"middle income"},{"agrd1960":0.37839946,"agrd2011":6.5224018,"id":"Myanmar","parentId":"low income"},{"agrd1960":33.683868,"agrd2011":66.763367,"id":"Sri Lanka","parentId":"middle income"},{"agrd1960":3.71841,"agrd2011":10.135754,"id":"Fiji","parentId":"middle income"},{"agrd1960":220.46313,"agrd2011":3771.1052,"id":"India","parentId":"middle income"},{"agrd1960":126.70251,"agrd2011":577.73279,"id":"Indonesia","parentId":"middle income"},{"agrd1960":6.1296725,"agrd2011":21.556534,"id":"Laos","parentId":"middle income"},{"agrd1960":34.607361,"agrd2011":687.15741,"id":"Malaysia","parentId":"middle income"},{"agrd1960":4.0657229,"agrd2011":44.281864,"id":"Nepal","parentId":"low income"},{"agrd1960":0.28730124,"agrd2011":1.7298965,"id":"Vanuatu","parentId":"middle income"},{"agrd1960":21.971193,"agrd2011":324.71265,"id":"Pakistan","parentId":"middle income"},{"agrd1960":12.142638,"agrd2011":27.113308,"id":"Papua New Guinea","parentId":"middle income"},{"agrd1960":40.899364,"agrd2011":324.25711,"id":"Philippines","parentId":"middle income"},{"agrd1960":80.027565,"agrd2011":445.05984,"id":"Thailand","parentId":"middle income"},{"agrd1960":0.11971017,"agrd2011":0.86139697,"id":"Tonga","parentId":"middle income"},{"agrd1960":0.11538577,"agrd2011":0.26504913,"id":"Tuvalu","parentId":"middle income"},{"agrd1960":3.8026001,"agrd2011":130.78661,"id":"Vietnam","parentId":"middle income"},{"agrd1960":0.37391976,"agrd2011":2.4437976,"id":"Samoa","parentId":"middle income"},{"agrd1960":293.72299,"agrd2011":4723.2188,"id":"China","parentId":"middle income"}];

function buildParams() {
	var params = {};

	params.width = d3.select("#content").node().clientWidth;
	params.height = params.width;

	params.year = "agrd-1960";
	params.defaultCountry = "All";
	params.country = params.defaultCountry;
	params.duration = 400;
	params.delay = 2;

	params.format = d3.format(",d");
	params.colourScale = d3.scaleOrdinal()
		.domain(["high income", "middle income", "low income"])
		.range(["#ee7183","#44b8c9","#8fc297"]);

	params.stratify = d3.stratify();

	params.treemap = d3.treemap()
		.size([params.width, params.height])
		.padding(1)
		.round(true);

	return params;
}

function BuildWidget (target, params, data) {
	this.target = target;
	this.params = params;
	this.data = data;
}

BuildWidget.prototype.build = function() {
	this.buildData();
	this.buildGraphic();
	this.updateTree();
	this.updateText();
	this.buildInput();
	this.buildTooltip();
};

BuildWidget.prototype.destroy = function(first_argument) {
	this.svg.remove();

	d3.select("#agrd-year input[name=year]#agrd1960").property("checked",true);
	d3.select("#agrd-year input[name=year]#agrd2011").property("checked",false);

	this.countrySelect.node().selectedIndex = 0;
};

BuildWidget.prototype.buildData = function() {
	var self = this;

	function growTree(data, year) {
		var root = self.params.stratify(data)
			.sum(function(d) {
				if (year === "1960") {
					return d.agrd1960;
				} else if (year === "2011") {
					return d.agrd2011;
				} else {
					return d.agrd1960;
				}
			});
		
			return self.params.treemap(root).leaves();
	}

	this.root1960 = growTree(this.data, "1960");
	this.root2011 = growTree(this.data, "2011");
};

BuildWidget.prototype.buildGraphic = function() {
	this.svg = d3.select(this.target)
		.append("svg")
		.attr("width", this.params.width)
		.attr("height", this.params.height);

	this.svgBoxes = this.svg.append("g");
	this.svgText = this.svg.append("g");
};

BuildWidget.prototype.buildInput = function() {
	var self = this;

	var countryNames = [];

	this.root1960.forEach(function(element, index, array) {
		if (element.data.agrd1960 > 2 && element.data.agrd2011 > 2) {
			countryNames.push(element.id);
		}
	});

	countryNames.sort().unshift(this.params.defaultCountry);

	this.radioYear = d3.selectAll("#agrd-year input[name=year]");

	this.radioYear.on("change", function() {
		self.params.year = this.value;
		self.updateTree();
		self.updateText();
	});

	this.countrySelect = d3.select("#agrd-country-select");

	this.countrySelect.selectAll("option")
		.data(countryNames)
		.enter()
		.append("option")
			.attr("value", function(d) {
				return d;
			})
			.text(function(d) {
				return d;
			});

	this.countrySelect.on("change", function() {
		self.params.country = this.value;
		self.updateTree();
	});
};

BuildWidget.prototype.findData = function() {
	if (this.params.year === "agrd-1960") {
		return this.root1960;
	} else {
		return this.root2011;
	}

};

BuildWidget.prototype.updateTree = function() {
	var self = this;

	function findOpacity(d) {
		if (self.params.country === self.params.defaultCountry) {
			return 1;
		} else {
			if (d.id === self.params.country) {
				return 1;
			} else {
				return 0.3;
			}
		}
	}

	/* JOIN */
	this.boxes = this.svgBoxes.selectAll("rect")
		.data(this.findData(), function(d) {
			return d.id;
		});
	
	/* EXIT */
	this.boxes.exit()
		.remove();
	
	/* UPDATE */
	this.boxes.transition()
		.duration(this.params.duration)
		.delay(function (d,i) {
				return i * self.params.delay;
		})
		.attr("x", function(d) {
			return d.x0;
		})
		.attr("y", function(d) {
			return d.y0;
		})
		.attr("width", function(d) {
			return d.x1 - d.x0;
		})
		.attr("height", function(d) {
			return d.y1 - d.y0;
		})
		.attr("opacity", function(d) {
			return findOpacity(d);
		});
	
	/* ENTER */
	this.boxes.enter()
		.append("rect")
		.attr("fill", function(d) {
				if (d.depth > 1) {
					return self.params.colourScale(d.parent.id);
				} else {
					return "#ffffff";
				}
		})
		.attr("x", function(d) {
			return d.x0;
		})
		.attr("y", function(d) {
			return d.y0;
		})
		.attr("width", function(d) {
			return d.x1 - d.x0;
		})
		.attr("height", function(d) {
			return d.y1 - d.y0;
		})
		.attr("stroke", "#666")
		.attr("stroke-width", 0)
		.attr("opacity", function(d) {
			return findOpacity(d);
		});
 
};

BuildWidget.prototype.updateText = function() {
	var self = this;
	var dy = 12;
	var dx = 3;

	function showHideText(d, that) {
		var textWidth = d3.select(that).node().getBBox().width;
		var textHeight = d3.select(that).node().getBBox().height;
		var boxWidth = d.x1 - d.x0 - dx;
		var boxHeight = d.y1 - d.y0 - dy;

		if (textWidth >= boxWidth || textHeight >= boxHeight) {
			return 0;
		} else {
			return 1;
		}
	}

	/* JOIN */
	this.text = this.svgText.selectAll("text")
		.data(this.findData(), function(d) {
			return d.id;
		});
	
	/* EXIT */
	this.text.exit()
		.remove();
	
	/* UPDATE */
	this.text.transition()
		.duration(this.params.duration)
		.delay(function (d,i) {
				return i * self.params.delay;
		})
		.attr("x", function(d) {
			return d.x0;
		})
		.attr("y", function(d) {
			return d.y0;
		})
		.attr("opacity", function(d) {
			var that = this;
			return showHideText(d, that);
		});
	
	/* ENTER */
	this.text.enter()
		.append("text")
		.text(function (d) {
			return d.id;
		})
		.attr("fill", "#ffffff")
		.attr("font-size","0.8em")
		.style("text-transform", "uppercase")
		.attr("x", function(d) {
			return d.x0;
		})
		.attr("y", function(d) {
			return d.y0;
		})
		.attr("dy", dy + "px")
		.attr("dx", dx + "px")
		.attr("pointer-events", "none")
		.attr("opacity", function(d) {
			var that = this;
			return showHideText(d, that);
		});
};

BuildWidget.prototype.buildTooltip = function() {
	var self = this;

	var top, left;

	this.svgBoxes.selectAll("rect")
		.on("mouseover", function(d) {
			d3.select("#agrd-country").text(d.id);
			d3.select("#agrd-value").text(parseFloat(d.value).toFixed(2));

			top = d.y0 + ((d.y1 - d.y0) / 2);
			left = d.x0 + ((d.x1 - d.x0) / 2);

			var tooltipWidth = parseInt(d3.select("#widget-tooltip").node().getBoundingClientRect().width, 10);
			var tooltipHeight = parseInt(d3.select("#widget-tooltip").node().getBoundingClientRect().height, 10);
	
			if ( d.x0 > (self.params.width * 0.6) ) {
				left -= (tooltipWidth + 8);
				d3.select("#widget-tooltip").classed("tooltip-left", true);
				d3.select("#widget-tooltip").classed("tooltip-right", false);
			} else {
				left += 8;
				d3.select("#widget-tooltip").classed("tooltip-left", false);
				d3.select("#widget-tooltip").classed("tooltip-right", true);
			}

			d3.select("#widget-tooltip")
				.style("top",  (top - (tooltipHeight / 2)) + "px")
				.style("left", left + "px")
				.classed("hidden", false);

			d3.select(this).attr("stroke-width", 2);
		})
		.on("mouseout", function(d) {
			self.hideTooltip();
			d3.select(this).attr("stroke-width", 0);
		});


};

BuildWidget.prototype.hideTooltip = function () {
	d3.select("#widget-tooltip").classed("hidden", true);
};

(function() {
	var init = function($)	{

		$(".outerwrapper").css("display","block");
		$(".status-message").css("display","none");

		/*	Load D3 */
		$.getScript("//d3js.org/d3.v4.min.js", function() {

			var width = $(window).width();
			var didResize = false;

			var params = buildParams();
			var widget = new BuildWidget("#agrd-chart", params, data);
			widget.build();

			$( window ).resize(function() {
				if($(window).width() != width){ 
					width = $(window).width();
					didResize = true;

					/* Throttle the resize */
					setTimeout(function () {
						if (didResize) {
							widget.destroy();
							widget.params = buildParams();
							widget.build();
							
							didResize = false;
						}
					}, 60);

				}
			});

		}); 
	};

	setTimeout(function() {
		if (typeof jQuery !== 'undefined'){
			init(jQuery);
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);
})();

</script>
<!--<![endif]-->